<lib name='jquery' />

<style type="text/css">
.browser {
	font-family: Verdana, helvetica, arial, sans-serif;
}
.selectClass{
	color:blue;
	font-weight:bold;
}
.structBrowser_right{
	float:right;
}
.structBrowser_left{
	width:700px;
	height:500px;
}
</style>

<script type="text/javascript">
function s_b_init (){
	this._mvcstruct = null;
	this.parentObject = null;
	this.allowSelectClass = new Array();
	this.selectType = "";
	
	var sAllowSelectClass = '{=$sAllowSelectClass}';
	for(var i =0 ; i< sAllowSelectClass.length ; i++){
		switch(sAllowSelectClass.substr(i,1))
		{
			case "c":
				this.allowSelectClass.push("controller");
				break;
			case "v":
				this.allowSelectClass.push("view");
				break;
			case "m":
				this.allowSelectClass.push("model");
				break;
			case "w":
				this.allowSelectClass.push("widget");
				break;
		}
	}
	this.selectType = '{=$sSelectType}';
}
var structBrowser = new s_b_init();

structBrowser.log = function(text)
{
	if( typeof(console)!='undefined' )
	{
		console.log(text) ;
	}
};
structBrowser.setMvcStruct = function(struct)
{
	this._mvcstruct = struct ;
	jQuery('#browser-controller').empty() ;
	jQuery('#browser-view').empty() ;
	this.loadMvcStruct(this._mvcstruct);
};
structBrowser.loadMvcStruct= function(struct)
{
	var browser_controller = jQuery('#browser-controller') ;
	var controller = jQuery('<li><span class="folder controller">[C] '+struct.name+'</span></li>') ;
	struct.itemType = 'controller';
	controller.find('.controller:first').data("data",struct);
	browser_controller.append(controller) ;
	var i,j;
	for( i in struct.controllers ){
		this.loadMvcStruct( struct.controllers[i] );
	}
	
	var browser_view = jQuery('#browser-view') ;
	for( i in struct.views ){
		var aView = struct.views[i];
		var view = jQuery("<li><span class='folder view'>[V] "+aView.name+"</span></li>") ;
		aView.itemType = 'view' ;
		aView.brothers = new Array();
		for( j in struct.views ){
			var bid = struct.views[j].id ;
			if( bid != aView.id ){
				aView.brothers.push(bid);
			}
		}
		view.find('.view:first').data("data",aView);
		browser_view.append(view) ;
	}
}
structBrowser.setCurrentUrl = function(sUrl)
{
	jQuery('#current_url').val(sUrl) ;
};

structBrowser.location = function(sUrl)
{
	if(typeof(sUrl)=='undefined')
	{
		sUrl = jQuery('#current_url').val() ;
	}
	if( sUrl.search('\\?') < 0 )
	{
		sUrl += '?' ;
	}
	if( sUrl.search("mvcmerger_browser") < 0 )
	{
		sUrl += "&mvcmerger_browser=1" ;
	}
	jQuery('#iframe-browser').get(0).contentWindow.location = sUrl ;
};
structBrowser.closeArgsAndTitleInputByNeed = function(){
	if( this.selectType == "target"){
		jQuery('#args').get(0).disabled = true;
		jQuery('#title').get(0).disabled = true;
	}
};
structBrowser.onSelectChange = function(o){
	this.log(o);
}
structBrowser.highlightInFrameById = function(id,color){
	var iframe = document.getElementById('iframe-browser');
	var fcd = iframe.contentWindow.document;
	var obj = fcd.getElementById(id);
	
	var flashing = jQuery('<div class="mergepannel-layout-flashing" style="position:absolute;z-index:300;background:'+color+';border:1px solid #666;filter:alpha(opacity=50);-moz-opacity:0.5;opacity: 0.5; "></div>');
	var position = jQuery(obj).offset();
	if( position != null ){
		iframe.contentWindow.scrollTo(position.left,position.top);
		var width = jQuery(obj).outerWidth(true);
		var height = jQuery(obj).outerHeight(true);
		flashing.css({'top' : position.top,'left' : position.left,'width' : width,'height' : height});
		jQuery(fcd).find('body').append(flashing);
		flashing.show();
	}
}
jQuery(function(){
	var iframe = document.getElementById('iframe-browser');
	
	<if "isset({=$sUrl})">
	iframe.contentWindow.location.href = '{=$sUrl}';
	</if>
	
	function SelectItem(jobj){
		var i;
		this.data = jobj.data('data');
		
		// params
		function removeDataNameIsUserCall( originStr ){
			var arr = originStr.split('&');
			var arrRtn = [] ;
			for( var key in arr){
				if( arr[key].indexOf(".data-name-is-user-call=") == 0){
					continue;
				}else{
					arrRtn.push( arr[key] );
				}
			}
			return arrRtn.join("&");
		}
		
		if( 'string' == typeof ( this.data.params ) ){
			this.data.params = removeDataNameIsUserCall(this.data.params);
		}
		
		this.itemType = function(){
			return this.data.itemType ;
		}
		this.id = function(){
			return this.data.id;
		}
		this.emit = function(){
			structBrowser.onSelectChange( this.data );
		}
	}
	
	jQuery(".folder").live("click",function(e){
		var jobj = jQuery(this) ;
		var ceo = new SelectItem( jobj );
		var bIsSelectClass = false;
		for(var c in structBrowser.allowSelectClass){
			if( structBrowser.allowSelectClass[c] == ceo.itemType() ){
				bIsSelectClass = true;
				break;
			}
		}
		if(!bIsSelectClass){
			return;
		}
		
		jQuery(".folder").removeClass("selectClass");
		jobj.addClass("selectClass");
		
		ceo.emit();
	});
	
	jQuery('.folder').live("mouseover",function(e){
		var jobj = jQuery(this);
		var moeo = new SelectItem(jobj);// mouse over event object
		
		if(moeo.itemType() == 'view' ){
			var id = moeo.id() ;
			structBrowser.highlightInFrameById(id,'blue');
			var j;
			for( j in moeo.data.brothers ){
				var vid = moeo.data.brothers[j];
				structBrowser.highlightInFrameById(vid,'aqua');
			}
		}else{
			var i;
			for( i in moeo.data.views ){
				var aView = moeo.data.views[i];
				var id = aView.id;
				structBrowser.highlightInFrameById(id,'pink');
			}
		}
	});
	
	jQuery('.folder').live("mouseout",function(){
		var fcd = iframe.contentWindow.document;
		// 取消 item 对应的 frame/view 闪烁样式
		jQuery(fcd).find('.mergepannel-layout-flashing').remove();
	});
	
	//frame加载监听以及自动刷新数据
	iframe.onload = function(){
		jquery('#current_url').val(iframe.contentWindow.location.href);
		var sUrl = iframe.contentWindow.location.href;
		if( sUrl.search("mvcmerger_browser") < 0 )
		{
			sUrl += "&mvcmerger_browser=1" ;
			iframe.contentWindow.location.href = sUrl;
		}
	};
});
</script>

<div class="structBrowser_right">
	请选择控制器:
	<ul id="browser-controller" class="browser" >
	</ul>
	请选择视图：
	<ul id="browser-view" class="browser" >
	</ul>
</div>

<div class="structBrowser_left">
	<div>
		<label>页面地址<input type="text" id="current_url" value="" style="width:400px" /></label> 
		<input type="button" value="打开网页" onclick="structBrowser.location();" />
	</div>
	
	<iframe id="iframe-browser" name="iframe-browser" src="?mvcmerger_browser=1" width="100%" height="100%"/>
</div>
